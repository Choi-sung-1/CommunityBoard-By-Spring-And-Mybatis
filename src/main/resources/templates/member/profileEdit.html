<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>마이페이지</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" />
    <style>
        body {
            background-color: #f8f9fa;
        }

        .profile-container {
            max-width: 720px;
            margin: 40px auto;
        }

        .img-preview {
            max-width: 160px;
            border-radius: 0.75rem;
            object-fit: cover;
        }

        .field-error {
            color: #dc3545;
            font-size: 0.875rem;
        }

        .form-floating > .form-control.is-invalid ~ label {
            color: #dc3545;
        }

        .btn-group-custom .btn {
            width: 48%;
        }
    </style>
</head>
<body>

<div class="container profile-container">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white fs-5 fw-semibold">
            👥 마이페이지
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data"
                  th:action="@{/member/profile/edit/{memberId}(memberId=${memberId})}"
                  th:object="${memberProfile}">

                <!-- 프로필 이미지 -->
                <div class="mb-4 text-center">
                    <label for="pfImage" class="form-label fw-semibold">프로필 이미지</label>
                    <div>
                        <img th:src="${filePath}" src="첨부 이미지" alt="프로필 이미지"
                             id="profileImage" class="img-preview mb-2" />
                    </div>
                    <input class="form-control" type="file" name="profileImage" id="pfImage" accept="image/*" onchange="previewImage(event)" />
                    <div class="mt-3" id="previewCard" style="display:none;">
                        <img id="preview" src="" alt="미리보기 이미지" class="img-preview d-block mx-auto" />
                    </div>
                </div>

                <!-- 한줄 소개 -->
                <div class="form-floating mb-3">
                    <input type="text" id="profileOneLineBio" name="profileOneLineBio"
                           th:value="*{profileOneLineBio}" class="form-control" placeholder="한줄 소개" />
                    <label for="profileOneLineBio">한줄 소개</label>
                </div>

                <!-- 이름 -->
                <div class="form-floating mb-3">
                    <input type="text" th:field="*{memberName}" class="form-control" id="memberName" placeholder="이름"/>
                    <label for="memberName">이름</label>
                    <div class="field-error" id="nameError"></div>
                </div>

                <!-- 아이디 -->
                <div class="form-floating mb-3">
                    <input type="text" th:field="*{memberLoginId}" class="form-control" readonly placeholder="아이디"/>
                    <label>아이디</label>
                </div>

                <!-- 이메일 -->
                <div class="form-floating mb-3">
                    <input type="email" id="memberEmail" th:field="*{memberEmail}" class="form-control" placeholder="이메일" />
                    <label for="memberEmail">이메일</label>
                    <div class="field-error" id="emailError"></div>
                </div>

                <!-- 생년월일 -->
                <div class="form-floating mb-3">
                    <input type="text" th:value="*{memberBirth}" class="form-control" readonly placeholder="생년월일"/>
                    <label>생년월일</label>
                </div>

                <!-- 전화번호 -->
                <div class="form-floating mb-3">
                    <input type="text" id="memberPhone" th:field="*{memberPhone}" class="form-control" placeholder="010-1234-5678" />
                    <label for="memberPhone">전화번호</label>
                    <div class="field-error" id="phoneError"></div>
                </div>

                <!-- 버튼 -->
                <div class="d-flex justify-content-between btn-group-custom mt-4">
                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">← 취소</button>
                    <button type="submit" class="btn btn-primary" onclick="validator()">수정하기</button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    function previewImage(event){
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function (e){
            const preview = document.getElementById("preview");
            const previewCard = document.getElementById("previewCard");
            preview.src = e.target.result;
            previewCard.style.display="block";
        };
        if(file){
            reader.readAsDataURL(file);
        }
    }

    function validator(event) {
        let isValid = true;

        // 이름 검증
        const nameInput = document.getElementById("memberName");
        const nameError = document.getElementById("nameError");
        const name = nameInput.value.trim();
        if (name.length < 2) {
            nameError.textContent = "이름은 최소 2자 이상 입력해야 합니다.";
            nameInput.classList.add("is-invalid");
            isValid = false;
        } else {
            nameError.textContent = "";
            nameInput.classList.remove("is-invalid");
        }

        // 전화번호 검증
        const phoneInput = document.getElementById("memberPhone");
        const phoneError = document.getElementById("phoneError");
        const phone = phoneInput.value.trim();
        const phoneRegex = /^010-\d{4}-\d{4}$/;

        if (phone !== "" && !phoneRegex.test(phone)) {
            phoneError.textContent = "전화번호는 010-1234-5678 형식이어야 합니다.";
            phoneInput.classList.add("is-invalid");
            isValid = false;
        } else {
            phoneError.textContent = "";
            phoneInput.classList.remove("is-invalid");
        }

        // 이메일 검증
        const emailInput = document.getElementById("memberEmail");
        const emailError = document.getElementById("emailError");
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email !=="" && !emailRegex.test(email)) {
            emailError.textContent = "유효한 이메일 형식을 입력하세요.";
            emailInput.classList.add("is-invalid");
            isValid = false;
        } else {
            emailError.textContent = "";
            emailInput.classList.remove("is-invalid");
        }

        // 최종 검증 실패 시 폼 제출 막기
        if (!isValid) {
            event.preventDefault();
        }
    }

    // 이벤트 바인딩
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        form.addEventListener("submit", validator);
    });
</script>

</body>
</html>
