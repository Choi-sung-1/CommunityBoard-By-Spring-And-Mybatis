<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 900px;
            margin: 2rem auto;
        }

        .card {
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        h2, h5 {
            font-weight: 600;
        }

        .image-item img {
            width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
            transition: transform 0.3s ease;
        }

        .image-item img:hover {
            transform: scale(1.05);
        }

        .like-btn {
            font-size: 1.1rem;
        }

        .commentBox {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            background-color: white;
        }

        textarea[readonly] {
            background-color: #fdfdfd;
            border: none;
            resize: none;
        }

        .btn-custom {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.5rem 1.2rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn-outline-primary {
            border-color: #4e73df;
            color: #4e73df;
            background-color: transparent;
        }
        .btn-outline-primary:hover {
            background-color: #4e73df;
            color: white;
        }

        .btn-outline-secondary {
            border-color: #858796;
            color: #858796;
            background-color: transparent;
        }
        .btn-outline-secondary:hover {
            background-color: #858796;
            color: white;
        }

        .btn-danger {
            background-color: white;
            color: red;
        }
        .btn-danger:hover {
            background-color: #c0392b;
            color: white;
        }
        .custom-indicators [data-bs-target] {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #d1d5db; /* ê¸°ë³¸ íšŒìƒ‰ */
            margin: 0 6px;
            border: none;
            transition: all 0.3s ease;
        }

        .custom-indicators .active {
            background-color: #4e73df; /* í™œì„±í™” ì‹œ íŒŒë€ìƒ‰ */
            width: 14px;
            height: 14px;
        }

    </style>
</head>
<body>
<div class="container">
    <div class="card shadow-sm">
        <div class="card-body">

            <!-- ì œëª© -->
            <h2 class="mb-4">ğŸ“Œ ê²Œì‹œê¸€</h2>

            <!-- ë¡œê·¸ì¸/ì‘ì„±ì ì •ë³´ -->
            <div th:if="${loginUser!=null}" class="mb-3 text-muted small">
                ğŸ‘¤ ë¡œê·¸ì¸: <strong th:text="${loginUser.memberLoginId}">ì‚¬ìš©ì</strong> |
                âœï¸ ì‘ì„±ì: <strong th:text="${postDetailDTO.memberLoginId}">ì‘ì„±ì</strong>
            </div>
            <div th:if="${loginUser==null}" class="alert alert-warning">
                âš ï¸ ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.
            </div>

            <!-- ê²Œì‹œê¸€ í¼ -->
            <form id="postForm" th:object="${postDetailDTO}">
                <div id="postId" th:attr="data-post-id=${postDetailDTO.id}" hidden></div>
                <div id="memberId" th:if="${loginUser!=null}" th:attr="data-member-id=${loginUser.id}" hidden></div>

                <!-- ì œëª© -->
                <div class="mb-3">
                    <h5>ì œëª©</h5>
                    <input type="text" th:field="*{postTitle}" class="form-control" readonly>
                </div>

                <!-- ì´ë¯¸ì§€ -->
                <div th:if="!${postDetailDTO.fileList.isEmpty()}" class="mb-3">
                    <h5>ì´ë¯¸ì§€</h5>
                    <div id="postImageCarousel" class="carousel slide" data-bs-ride="false">
                        <!-- ì´ë¯¸ì§€ë“¤ -->
                        <div class="carousel-inner">
                            <div th:each="file, stat : ${postDetailDTO.fileList}"
                                 class="carousel-item"
                                 th:classappend="${stat.index == 0} ? ' active'">
                                <img th:src="@{|/postImages/${file.fileOriginalName}|}"
                                     class="d-block w-100 rounded"
                                     alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€">
                            </div>
                        </div>

                        <!-- ì¸ë””ì¼€ì´í„° (ì•„ë˜ ì  ë²„íŠ¼) -->
                        <div class="carousel-indicators custom-indicators">
                            <button th:each="file, stat : ${postDetailDTO.fileList}"
                                    type="button"
                                    data-bs-target="#postImageCarousel"
                                    th:attr="data-bs-slide-to=${stat.index}"
                                    th:classappend="${stat.index == 0} ? ' active'"
                                    aria-current="true"
                                    th:attrappend="aria-label=${'Slide ' + (stat.index + 1)}">
                            </button>
                        </div>

                        <!-- ì´ì „ ë²„íŠ¼ -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#postImageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <!-- ë‹¤ìŒ ë²„íŠ¼ -->
                        <button class="carousel-control-next" type="button" data-bs-target="#postImageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>



                <!-- ë‚´ìš© -->
                <div class="mb-3">
                    <h5>ë‚´ìš©</h5>
                    <textarea th:text="*{postContent}" class="form-control" rows="6" readonly></textarea>
                </div>

                <!-- ì¥ì†Œ -->
                <div th:if="*{!postRegisterLocation.isEmpty()}" class="mb-3">
                    <h5>ğŸ“ ì¥ì†Œ</h5>
                    <input type="text" th:field="*{postRegisterLocation}" readonly class="form-control">
                </div>

                <!-- ì¢‹ì•„ìš” -->
                <div class="mb-4">
                    <div id="likeStatus" th:if="${likeStatus!=null}" th:attr="data-like-status=${likeStatus}" hidden></div>
                    <button id="likeButton" type="button" class="btn btn-outline-danger like-btn btn-custom" onclick="onClickLikeButton()">
                        â¤ï¸ <span th:text="*{postLikeCount}" id="likeCount">0</span>
                    </button>
                </div>

                <hr>

                <!-- ëŒ“ê¸€ ì‘ì„± -->
                <div class="mb-4" th:if="${loginUser!=null}">
                    <h5>ğŸ’¬ ëŒ“ê¸€ ì‘ì„±</h5>
                    <textarea id="commentContent" class="form-control mb-2" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <button id="commentButton" type="button" class="btn btn-outline-primary btn-custom" onclick="onClickCommentButton()">ëŒ“ê¸€ ì‘ì„±</button>
                </div>

                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div id="commentList">
                    <h5 class="mb-3">ğŸ“ ëŒ“ê¸€ ëª©ë¡</h5>
                    <div class="commentBox" th:each="comment:${comments}" th:attr="data-comment-id=${comment.id}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong th:text="${comment.commentWriterName}">ì‘ì„±ì</strong>
                                <small class="text-muted ms-2" th:text="${comment.getCommentRegisterDate()}">ë‚ ì§œ</small>
                            </div>
                            <button th:if="${loginUser != null and loginUser.memberLoginId == comment.commentWriterName}"
                                    type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    onclick="deleteComment(this)">ğŸ—‘ ì‚­ì œ</button>
                        </div>
                        <textarea th:text="${comment.commentContent}" class="form-control" rows="2" readonly></textarea>
                    </div>
                </div>

                <hr>

                <!-- ìˆ˜ì •/ì‚­ì œ/ëª©ë¡ -->
                <div class="d-flex gap-2">
                    <a th:if="${loginUser != null} and ${loginUser.memberLoginId} == ${postDetailDTO.memberLoginId}"
                       th:href="@{/post/edit/{postId}(postId=${postDetailDTO.id})}"
                       class="btn btn-outline-secondary btn-custom">âœï¸ ìˆ˜ì •</a>

                    <a th:if="${loginUser != null} and ${loginUser.memberLoginId} == ${postDetailDTO.memberLoginId}"
                       th:href="@{/post/delete/{postId}(postId=${postDetailDTO.id})}"
                       onclick="return deleteOnclick()"
                       class="btn btn-danger btn-custom">âŒ ì‚­ì œ</a>

                    <button type="button" th:onclick="|location.href='@{/post/list}'|" class="btn btn-outline-primary btn-custom">ğŸ“‹ ëª©ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const likeStatusElement = document.getElementById("likeStatus");
        const likeStatus = likeStatusElement.dataset.likeStatus;
        updateLikeButtonStyle(likeStatus);
    });

    //ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­
function onClickLikeButton() {
    // ì´ˆê¸° liked ê°’ ì„¤ì •
    let liked = document.getElementById('likeStatus').dataset.status === 'onClick';
    liked = !liked; // ìƒíƒœ ë’¤ì§‘ê¸°
    const likeButtonStatus = liked ? 'onClick' : 'noneClick';
    const likeCount = document.getElementById('likeCount');
    const postId = document.getElementById('postId').dataset.postId;
    const memberId = document.getElementById('memberId').dataset.memberId;

    // ì„œë²„ ìš”ì²­
    fetch('/post/like', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            postId: Number(postId),
            memberId: Number(memberId),
            likeButtonStatus: likeButtonStatus
        })
    })
        .then(response => response.json())
        .then(data => {
            likeCount.textContent = data.likeCount;
            updateLikeButtonStyle(data.likeStatus);
        });
}

//ê²Œì‹œê¸€ ì‚­ì œ ì»¨íŒ
function deleteOnclick() {
    return confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
}
// ëŒ“ê¸€ ì‘ì„±
function onClickCommentButton() {
    let commentContent = document.getElementById('commentContent').value;
    const postId =document.getElementById('postId').dataset.postId;
    const memberId =document.getElementById('memberId').dataset.memberId

    if (!commentContent || commentContent.trim() === '') {
        // ê³µë°± ë˜ëŠ” ë¹„ì–´ ìˆëŠ” ëŒ“ê¸€ì¼ ë•Œ ì²˜ë¦¬
        alert("ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");
        return;
    }
    fetch('/comment/add',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            postId:Number(postId),
            memberId:Number(memberId),
            commentContent:commentContent
        })
    }).then(response=>response.json())
        .then(comment=>{
            appendCommentList(comment);
            document.getElementById('commentContent').value ="";

        })
}
// ëŒ“ê¸€ ìš”ì†Œ ì¶”ê°€
    function appendCommentList(comment) {
        const commentList = document.getElementById('commentList');

        const commentBox = document.createElement("div");
        commentBox.classList.add("commentBox");
        commentBox.dataset.commentId = comment.id;

        // ìƒë‹¨ ì‘ì„±ì + ë‚ ì§œ + ì‚­ì œ ë²„íŠ¼
        const topRow = document.createElement("div");
        topRow.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

        const writerDiv = document.createElement("div");
        const strong = document.createElement("strong");
        strong.textContent = comment.commentWriterName;
        const small = document.createElement("small");
        small.textContent = comment.commentRegisterDate;
        small.classList.add("text-muted", "ms-2");

        writerDiv.appendChild(strong);
        writerDiv.appendChild(small);

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "ğŸ—‘ ì‚­ì œ";
        deleteButton.onclick = function () { deleteComment(deleteButton); };
        deleteButton.classList.add("btn", "btn-sm", "btn-outline-danger");

        topRow.appendChild(writerDiv);
        topRow.appendChild(deleteButton);

        // ëŒ“ê¸€ ë‚´ìš©
        const contentTextarea = document.createElement("textarea");
        contentTextarea.setAttribute("readonly", true);
        contentTextarea.textContent = comment.commentContent;
        contentTextarea.classList.add("form-control");
        contentTextarea.rows = 2;

        commentBox.appendChild(topRow);
        commentBox.appendChild(contentTextarea);

        // ë™ì ìœ¼ë¡œ ì¶”ê°€
        commentList.appendChild(commentBox);
    }

// ëŒ“ê¸€ ì‚­ì œ
function deleteComment(button) {
    const commentBox = button.closest('.commentBox'); // ê°€ì¥ ê°€ê¹Œìš´ ë¶€ëª¨ div ì°¾ê¸°
    const commentId = commentBox.dataset.commentId;

    fetch(`/comment/delete/${commentId}`, {
        method: 'DELETE'
    }).then(response => {
        if (!response.ok) {
            throw new Error("ì‚­ì œ ì‹¤íŒ¨");
        }
        return response.json(); // OK ì‘ë‹µì¼ ê²½ìš°
    });
    commentBox.remove();
//     ì‚­ì œëŠ”ë˜ëŠ”ë° ë¹„ë™ê¸°ë¡œ ì‚­ì œê°€ì•ˆë¨
}
// ì¢‹ì•„ìš” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateLikeButtonStyle(status) {
        const likeButton = document.getElementById("likeButton");

        if (status === "onClick") {
            likeButton.classList.add("btn-danger");
            likeButton.style.backgroundColor = "red";
            likeButton.style.color = "white";  // í´ë¦­ ì‹œ í°ìƒ‰ ê¸€ì
        } else {
            likeButton.classList.remove("btn-danger");
            likeButton.style.backgroundColor="white";
            likeButton.style.color = "red";    // ì•„ë‹ ë•Œ ë¹¨ê°„ ê¸€ì
        }
    }

    </script>
</body>
</html>
