<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link th:href="@{/css/bootstrap.min.css}" href="/css/bootstrap.min.css" rel="stylesheet">
    <title>ê²Œì‹œê¸€</title>
</head>
<body>
<div >
    <div>
        <h2>ğŸ“Œ ê²Œì‹œê¸€</h2>
        <div th:if="${loginUser!=null}">
            <span>
                    ğŸ‘¤ ë¡œê·¸ì¸ ì‚¬ìš©ì: <span th:text="${loginUser.memberLoginId}">ì‚¬ìš©ì</span>
            </span>
            <span>
                    âœï¸ ì‘ì„±ì: <span th:text="${post.memberLoginId}">ì‘ì„±ì</span>
            </span>
        </div>
        <div th:if="${loginUser==null}">
            <span>âš ï¸ ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</span>
        </div>

        <form id="postForm" action="/post" method="post" th:object="${post}">
            <div id="postId" th:attr="data-post-id=${post.id}" hidden="hidden"></div>
            <div id="memberId" th:if="${loginUser}!=null" th:attr="data-member-id=${loginUser.id}" hidden="hidden"></div>
            <div>
                <label for="postTitle">ì œëª©</label>
                <input type="text" id="postTitle"
                       th:field="*{postTitle}" readonly>
            </div>

            <div th:if="!${post.fileList.isEmpty()}">
                <label for="viewCard">ì´ë¯¸ì§€</label>
                <div th:each="file : ${post.fileList}">
                    <div th:text="@{|/postImages/${file.fileOriginalName}|}"></div>
                    <img th:src="@{|/postImages/${file.fileOriginalName}|}" id="viewCard" style="max-width: 200px;" />
                </div>
            </div>
            <div>
                <label for="postContent">ë‚´ìš©</label>
                <div>
                    <textarea th:text="*{postContent}" id="postContent" rows="6" readonly></textarea>
                </div>
            </div>
            <div>
                <div id="likeStatus" th:if="${likeStatus!=null}" th:attr="data-like-status=${likeStatus}" hidden></div>
                <button id="likeButton"
                        type="button"
                        onclick="onClickLikeButton()">
                    â¤ï¸ <span th:text="*{postLikeCount}" id="likeCount">0</span>
                </button>

            </div>
            <hr class="my-4">

            <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
            <div class="mb-3" th:if="${loginUser!=null}">
                <label for="commentContent">ğŸ’¬ ëŒ“ê¸€ ì‘ì„±</label>
                    <div>
                        <textarea id="commentContent" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>

                <div>
                    <button id="commentButton" type="button" onclick="onClickCommentButton()">ëŒ“ê¸€ ì‘ì„±</button>
                </div>
            </div>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div id="commentList">
                <h5>ğŸ“ ëŒ“ê¸€ ëª©ë¡</h5>
                <div class="commentBox" th:each="comment:${comments}" th:attr="data-comment-id=${comment.id}">
                    <div>
                        <strong th:text="${comment.commentWriterName}">ì‘ì„±ì</strong>
                        <small th:text="${comment.getCommentRegisterDate()}">ë‚ ì§œ</small>
                        <button th:if="${loginUser != null and post != null  and loginUser.memberLoginId == comment.commentWriterName}"
                                type="button"
                                onclick="deleteComment(this)">
                            ğŸ—‘ ì‚­ì œ
                        </button>
                    </div>
                    <textarea th:text="${comment.commentContent}">ëŒ“ê¸€ ë‚´ìš©</textarea>
                </div>

            </div>

            <div>
                <div th:if="${loginUser != null} and ${loginUser.memberLoginId} == ${post.memberLoginId}">
                    <a th:href="@{/post/edit/{postId}(postId=${post.id})}">ï¸âœï¸ ìˆ˜ì •</a>
                </div>
                <div th:if="${loginUser != null} and ${loginUser.memberLoginId} == ${post.memberLoginId}">
                    <a th:href="@{/post/delete/{postId}(postId=${post.id})}" onclick="return deleteOnclick()">ï¸âŒ ì‚­ì œ</a>
                </div>
                <div>
                    <button type="button" th:onclick="|location.href='@{/post/list}'|">
                        ğŸ“‹ ëª©ë¡
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
</body>
</html>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const likeStatusElement = document.getElementById("likeStatus");
        const likeStatus = likeStatusElement.dataset.likeStatus;

        console.log("ì´ˆê¸° ì¢‹ì•„ìš” ìƒíƒœ:", likeStatus); // ë¡œê·¸ë¡œ í™•ì¸í•´ë³´ê¸°
        updateLikeButtonStyle(likeStatus);
    });

    //ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­
function onClickLikeButton() {
    // ì´ˆê¸° liked ê°’ ì„¤ì •
    let liked = document.getElementById('likeStatus').dataset.status === 'onClick';
    liked = !liked; // ìƒíƒœ ë’¤ì§‘ê¸°
    const likeButtonStatus = liked ? 'onClick' : 'noneClick';
    const likeCount = document.getElementById('likeCount');
    const postId = document.getElementById('postId').dataset.postId;
    const memberId = document.getElementById('memberId').dataset.memberId;

    // ì„œë²„ ìš”ì²­
    fetch('/post/like', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            postId: Number(postId),
            memberId: Number(memberId),
            likeButtonStatus: likeButtonStatus
        })
    })
        .then(response => response.json())
        .then(data => {
            likeCount.textContent = data.likeCount;
            updateLikeButtonStyle(data.likeStatus);
        });
}

//ê²Œì‹œê¸€ ì‚­ì œ ì»¨íŒ
function deleteOnclick() {
    return confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
}
// ëŒ“ê¸€ ì‘ì„±
function onClickCommentButton() {
    let commentContent = document.getElementById('commentContent').value;
    const postId =document.getElementById('postId').dataset.postId;
    const memberId =document.getElementById('memberId').dataset.memberId

    fetch('/comment/add',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            postId:Number(postId),
            memberId:Number(memberId),
            commentContent:commentContent
        })
    }).then(response=>response.json())
        .then(comment=>{
            appendCommentList(comment);
            document.getElementById('commentContent').value ="";

        })
}
// ëŒ“ê¸€ ìš”ì†Œ ì¶”ê°€
function appendCommentList(comment){
    const commentList = document.getElementById('commentList');
    const commentBox = document.createElement("div");
    commentBox.classList.add("commentBox");
    commentBox.dataset.commentId = comment.id;

    const topRow = document.createElement("div");

    const writerInfo = document.createElement("div");
    const strong = document.createElement("strong");
    strong.textContent = comment.commentWriterName;
    const small = document.createElement("small");
    small.textContent = comment.commentRegisterDate;

    writerInfo.appendChild(strong);
    writerInfo.appendChild(small);

    topRow.appendChild(writerInfo);

    const deleteButton = document.createElement("button");
    deleteButton.textContent = "ğŸ—‘ ì‚­ì œ";
    deleteButton.setAttribute("onclick","deleteComment(this)");
    writerInfo.appendChild(deleteButton);

    const contentDiv = document.createElement("textarea");
    contentDiv.textContent = comment.commentContent;

    commentBox.appendChild(topRow);
    commentBox.appendChild(contentDiv);

    commentList.appendChild(commentBox);
}
// ëŒ“ê¸€ ì‚­ì œ
function deleteComment(button) {
    const commentBox = button.closest('.commentBox'); // ê°€ì¥ ê°€ê¹Œìš´ ë¶€ëª¨ div ì°¾ê¸°
    const commentId = commentBox.dataset.commentId;

    fetch(`/comment/delete/${commentId}`, {
        method: 'DELETE'
    }).then(response => {
        if (!response.ok) {
            throw new Error("ì‚­ì œ ì‹¤íŒ¨");
        }
        return response.json(); // OK ì‘ë‹µì¼ ê²½ìš°
    });
    commentBox.remove();
//     ì‚­ì œëŠ”ë˜ëŠ”ë° ë¹„ë™ê¸°ë¡œ ì‚­ì œê°€ì•ˆë¨
}
// ì¢‹ì•„ìš” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateLikeButtonStyle(status) {
    const likeButton = document.getElementById("likeButton");

    if (status === "onClick") {
        likeButton.classList.add("btn-danger");
    } else {
        likeButton.classList.remove("btn-danger");
    }
}

</script>