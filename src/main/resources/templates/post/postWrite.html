<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="utf-8">
    <title>게시글 작성</title>
    <link th:href="@{/css/bootstrap.min.css}" href="/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            max-width: 800px;
            margin: 40px auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .form-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .field-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        .field-error::before {
            content: "⚠️ ";
            font-size: 1rem;
        }

        #previewCard img {
            max-width: 150px;
            max-height: 150px;
            margin: 5px;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-custom {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn-success {
            background-color: #4e73df;
            border: none;
            color: white;
        }

        .btn-success:hover {
            background-color: #2e59d9;
        }

        .btn-outline-primary {
            border-color: #4e73df;
            color: #4e73df;
            background-color: transparent;
        }
        .btn-outline-primary:hover {
            background-color: #4e73df;
            color: white;
        }

        .btn-outline-secondary {
            border-color: #858796;
            color: #858796;
            background-color: transparent;
        }
        .btn-outline-secondary:hover {
            background-color: #858796;
            color: white;
        }

        .form-label {
            font-weight: 600;
        }

        textarea.form-control {
            resize: vertical;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="form-header">
        📝 게시글 작성
    </div>

    <h5 th:if="${loginMember == null}" class="text-danger">로그인 후 이용해주세요.</h5>
    <h6 th:if="${loginMember != null}" th:text="|로그인 사용자 : ${loginMember.memberLoginId}|" class="text-muted mb-3"></h6>

    <form id="postForm" name="postForm" method="post" th:object="${postVO}" enctype="multipart/form-data">

        <!-- 제목 -->
        <div class="mb-3">
            <label for="postTitle" class="form-label">제목</label>
            <input th:field="*{postTitle}" th:classappend="${#fields.hasErrors('postTitle')} ? ' is-invalid' : ''"
                   type="text" id="postTitle" class="form-control" placeholder="제목을 입력해주세요.">
            <div class="field-error" th:errors="*{postTitle}">postTitle Error</div>
        </div>

        <!-- 이미지 업로드 -->
        <div class="mb-3">
            <label for="imageInput" class="form-label">이미지 첨부</label>
            <input type="file" id="imageInput" name="imageFiles" accept="image/*" multiple class="form-control"
                   onchange="previewImages(event)">
            <div id="previewCard" class="mt-3 d-flex flex-wrap"></div>
        </div>

        <!-- 내용 -->
        <div class="mb-3">
            <label for="postContent" class="form-label">내용</label>
            <textarea id="postContent" rows="6" th:classappend="${#fields.hasErrors('postContent')} ? ' is-invalid' : ''"
                      th:field="*{postContent}" class="form-control" placeholder="내용을 2글자 이상 입력해주세요."></textarea>
            <div class="field-error" th:errors="*{postContent}">postContent Error</div>
        </div>

        <!-- 위치 선택 -->
        <div id="container" class="mb-3" hidden>
            <label class="form-label">위치 선택</label>
            <div id="map" style="width: 100%; height: 250px;" class="mb-2 border rounded"></div>
            <div id="result" class="mb-2 text-muted">🗺️ 지도 클릭 시 정보 표시</div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary btn-custom" onclick="selectLocation()">선택</button>
                <button type="button" class="btn btn-outline-secondary btn-custom" onclick="cancelLocation()">취소</button>
            </div>
        </div>

        <!-- 현재 위치 표시 -->
        <div id="locDiv" class="mb-3">
            <label class="form-label">📍 장소</label>
            <div id="currentAddress" class="mb-2" th:field="*{postRegisterLocation}"></div>
            <input type="hidden" th:field="*{postRegisterLocation}" id="postRegisterLocation">
            <button type="button" class="btn btn-outline-primary btn-custom" onclick="showMap()">위치선택</button>
        </div>

        <!-- 버튼 영역 -->
        <div class="d-flex justify-content-end gap-2 mt-4">
            <a th:href="@{/post/list}" class="btn btn-outline-secondary btn-custom">목록으로</a>
            <button type="submit" class="btn btn-success btn-custom">작성하기</button>
        </div>
    </form>
</div>

<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1553256d332dc51b9fb4eb124bdfb16d&libraries=services"></script>
<script>
    let map;
    let marker = null;
    const geocoder = new kakao.maps.services.Geocoder();
    const currentAdd = document.getElementById('currentAddress');
    let selectedAddress = '';

    function showMap() {
        document.getElementById('container').hidden = false;
        document.getElementById('locDiv').hidden = true;

        const mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };

        map = new kakao.maps.Map(document.getElementById('map'), mapOption);
        map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
        map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            onMarker(mouseEvent.latLng);
        });

        getCurrentLocation();
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const userLatLng = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                map.setCenter(userLatLng);
                onMarker(userLatLng);
            }, function() {
                alert('위치 정보를 가져올 수 없습니다.');
            });
        } else {
            alert('브라우저가 위치 정보를 지원하지 않습니다.');
        }
    }

    function onMarker(coords) {
        if (marker) marker.setMap(null);
        marker = new kakao.maps.Marker({ position: coords });
        marker.setMap(map);
        map.setCenter(coords);
        showAddress(coords);
    }

    function showAddress(coords) {
        geocoder.coord2Address(coords.getLng(), coords.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const roadAddress = result[0].road_address;
                const jibunAddress = result[0].address;
                selectedAddress = roadAddress ? '도로명주소 : ' + roadAddress.address_name :
                    jibunAddress ? '지번주소 : ' + jibunAddress.address_name :
                        '주소 정보를 찾을 수 없습니다.';
                document.getElementById('result').innerText = selectedAddress;
            }
        });
    }

    function selectLocation() {
        currentAdd.innerText = selectedAddress;
        document.getElementById('postRegisterLocation').value = selectedAddress;
        document.getElementById('container').hidden = true;
        document.getElementById('locDiv').hidden = false;
    }

    function cancelLocation() {
        currentAdd.innerText = '';
        document.getElementById('container').hidden = true;
        document.getElementById('locDiv').hidden = false;
    }

    function previewImages(event) {
        const files = event.target.files;
        const previewCard = document.getElementById("previewCard");
        previewCard.innerHTML = "";

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement("img");
                img.src = e.target.result;
                img.alt = "첨부 이미지";
                previewCard.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }
</script>
</body>
</html>
