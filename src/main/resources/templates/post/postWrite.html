<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="utf-8">
    <title>ê²Œì‹œê¸€ ì‘ì„±</title>
    <link th:href="@{/css/bootstrap.min.css}" href="/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .field-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 4px;
        }

        .field-error::before {
            content: "âš ï¸ ";
            font-size: 1rem;
        }

        body {
            background-color: #f8f9fa;
        }

        .card {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .form-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #previewCard img {
            max-width: 150px;
            max-height: 150px;
            margin: 5px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="form-header">
        ğŸ“ ê²Œì‹œê¸€ ì‘ì„±
    </div>

    <h5 th:if="${loginMember == null}" class="text-danger">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</h5>
    <h6 th:if="${loginMember != null}" th:text="|ë¡œê·¸ì¸ ì‚¬ìš©ì : ${loginMember.memberLoginId}|" class="text-muted mb-3"></h6>

    <form id="postForm" name="postForm" method="post" th:object="${postVO}" enctype="multipart/form-data">

        <!-- ì œëª© -->
        <div class="mb-3">
            <label for="postTitle" class="form-label">ì œëª©</label>
            <input th:field="*{postTitle}" th:classappend="${#fields.hasErrors('postTitle')} ? ' is-invalid' : ''"
                   type="text" id="postTitle" class="form-control" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
            <div class="field-error" th:errors="*{postTitle}">postTitle Error</div>
        </div>

        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
        <div class="mb-3">
            <label for="imageInput" class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€</label>
            <input type="file" id="imageInput" name="imageFiles" accept="image/*" multiple class="form-control"
                   onchange="previewImages(event)">
            <div id="previewCard" class="mt-3 d-flex flex-wrap"></div>
        </div>

        <!-- ë‚´ìš© -->
        <div class="mb-3">
            <label for="postContent" class="form-label">ë‚´ìš©</label>
            <textarea id="postContent" rows="6" th:classappend="${#fields.hasErrors('postContent')} ? ' is-invalid' : ''"
                      th:field="*{postContent}" class="form-control" placeholder="ë‚´ìš©ì„ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
            <div class="field-error" th:errors="*{postContent}">postContent Error</div>
        </div>

        <!-- ìœ„ì¹˜ ì„ íƒ (ì§€ë„ ì˜ì—­) -->
        <div id="container" class="mb-3" hidden>
            <label class="form-label">ìœ„ì¹˜ ì„ íƒ</label>
            <div id="map" style="width: 100%; height: 250px;" class="mb-2 border rounded"></div>
            <div id="result" class="mb-2 text-muted">ğŸ—ºï¸ ì§€ë„ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ</div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-primary" onclick="selectLocation()">ì„ íƒ</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelLocation()">ì·¨ì†Œ</button>
            </div>
        </div>

        <!-- í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ -->
        <div id="locDiv" class="mb-3">
            <label class="form-label">ğŸ“ ì¥ì†Œ</label>
            <div id="currentAddress" class="mb-2" th:field="*{postRegisterLocation}"></div>
            <input type="hidden" th:field="*{postRegisterLocation}" id="postRegisterLocation">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="showMap()">ìœ„ì¹˜ì„ íƒ</button>
        </div>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div class="d-flex justify-content-end gap-2 mt-4">
            <a th:href="@{/post/list}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
            <button type="submit" class="btn btn-success">ì‘ì„±í•˜ê¸°</button>
        </div>
    </form>
</div>

<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1553256d332dc51b9fb4eb124bdfb16d&libraries=services"></script>
<script>
    let map;
    let marker = null;
    const geocoder = new kakao.maps.services.Geocoder();
    const currentAdd = document.getElementById('currentAddress');
    let selectedAddress = '';

    function showMap() {
        document.getElementById('container').hidden = false;
        document.getElementById('locDiv').hidden = true;

        const mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };

        map = new kakao.maps.Map(document.getElementById('map'), mapOption);
        map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
        map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            onMarker(mouseEvent.latLng);
        });

        getCurrentLocation();
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const userLatLng = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                map.setCenter(userLatLng);
                onMarker(userLatLng);
            }, function() {
                alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
        } else {
            alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
    }

    function onMarker(coords) {
        if (marker) marker.setMap(null);
        marker = new kakao.maps.Marker({ position: coords });
        marker.setMap(map);
        map.setCenter(coords);
        showAddress(coords);
    }

    function showAddress(coords) {
        geocoder.coord2Address(coords.getLng(), coords.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const roadAddress = result[0].road_address;
                const jibunAddress = result[0].address;
                selectedAddress = roadAddress ? 'ë„ë¡œëª…ì£¼ì†Œ : ' + roadAddress.address_name :
                    jibunAddress ? 'ì§€ë²ˆì£¼ì†Œ : ' + jibunAddress.address_name :
                        'ì£¼ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                document.getElementById('result').innerText = selectedAddress;
            }
        });
    }

    function selectLocation() {
        currentAdd.innerText = selectedAddress;
        document.getElementById('postRegisterLocation').value = selectedAddress;
        document.getElementById('container').hidden = true;
        document.getElementById('locDiv').hidden = false;
    }

    function cancelLocation() {
        currentAdd.innerText = '';
        document.getElementById('container').hidden = true;
        document.getElementById('locDiv').hidden = false;
    }

    function previewImages(event) {
        const files = event.target.files;
        const previewCard = document.getElementById("previewCard");
        previewCard.innerHTML = "";

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement("img");
                img.src = e.target.result;
                img.alt = "ì²¨ë¶€ ì´ë¯¸ì§€";
                previewCard.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }
</script>
</body>
</html>
